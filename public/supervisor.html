<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seleccionar Supervisor y Servicio</title>
  <link rel="stylesheet" href="supervisor.css">
</head>
<body>
  <main class="wrap">
    <h1>üë§ Supervisor ‚Üí üè• Servicio</h1>

    <section class="card">
      <label for="supervisorInput">Supervisor</label>
      <input id="supervisorInput" type="text" list="listaSupervisores" placeholder="Escribe el nombre del supervisor‚Ä¶" autocomplete="off" />
      <datalist id="listaSupervisores"></datalist>

      <label for="servicioSelect" style="margin-top:12px;">Servicio</label>
      <select id="servicioSelect" disabled>
        <option value="">Eleg√≠ un servicio‚Ä¶</option>
      </select>

      <div class="row mt">
        <button id="btnIr" class="primary">Ir al cat√°logo</button>
        <button id="btnLimpiar" class="ghost">Limpiar</button>
      </div>

      <p class="hint">Al entrar al cat√°logo se aplicar√° un filtro con los insumos habilitados para ese servicio.</p>
    </section>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    const input = $('#supervisorInput');
    const lista = $('#listaSupervisores');
    const sel   = $('#servicioSelect');
    const btnIr = $('#btnIr');
    const btnLimpiar = $('#btnLimpiar');

    let DATA = null; // JSON completo
    let mapaSup = new Map(); // nombre ‚Üí objetoSupervisor

    // Carga JSON (intenta embebido primero, luego archivo)
    async function loadJSON() {
      const embedded = document.getElementById('supervisores-data');
      if (embedded) {
        return JSON.parse(embedded.textContent);
      }
      const res = await fetch('/data/supervisores.json');
      if (!res.ok) throw new Error('No pude cargar supervisores.json');
      return await res.json();
    }

    function poblarSupervisores() {
      lista.innerHTML = '';
      mapaSup.clear();
      for (const sup of (DATA.supervisores || [])) {
        mapaSup.set(sup.nombre, sup);
        const opt = document.createElement('option');
        opt.value = sup.nombre;
        lista.appendChild(opt);
      }
    }

    function poblarServicios(nombre) {
      sel.innerHTML = '<option value="">Eleg√≠ un servicio‚Ä¶</option>';
      sel.disabled = true;

      const sup = mapaSup.get(nombre);
      if (!sup) return;

      for (const s of (sup.servicios || [])) {
        const opt = document.createElement('option');
        opt.value = s.id; // este ID se usa en el cat√°logo
        opt.textContent = s.nombre || s.id;
        sel.appendChild(opt);
      }
      sel.disabled = (sup.servicios || []).length === 0;
      if ((sup.servicios || []).length === 1) sel.selectedIndex = 1;
    }

    input.addEventListener('input', () => poblarServicios(input.value));

    btnLimpiar.addEventListener('click', (e) => {
      e.preventDefault();
      input.value = '';
      poblarServicios('');
    });

    btnIr.addEventListener('click', (e) => {
      e.preventDefault();
      const nombre = input.value.trim();
      const servicioId = sel.value;
      if (!mapaSup.has(nombre)) { alert('Eleg√≠ un supervisor v√°lido.'); return; }
      if (!servicioId) { alert('Eleg√≠ un servicio.'); return; }

      const url = `/index.html?service=${encodeURIComponent(servicioId)}&supervisor=${encodeURIComponent(nombre)}`;
      window.location.href = url;
    });

    (async () => {
      try {
        DATA = await loadJSON();
        poblarSupervisores();
      } catch (e) {
        console.error(e);
        alert('No pude cargar supervisores.json');
      }
    })();
  </script>
</body>
</html>
