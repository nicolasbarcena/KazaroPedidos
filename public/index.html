<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acceso ‚Äî Kazar√≥</title>
  <link rel="stylesheet" href="/login.css">
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>üîê Acceso</h1>
      <p class="subtitle">Ingresa con tu usuario y contrase√±a asignados.</p>

      <form id="loginForm" autocomplete="on" novalidate>
        <label for="user">Usuario</label>
        <input id="user" name="username" type="text" required autofocus placeholder="usuario" />

        <label for="pass">Contrase√±a</label>
        <div class="pw-row">
          <input id="pass" name="password" type="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
          <button type="button" id="togglePw" class="ghost small" aria-label="Mostrar u ocultar contrase√±a">üëÅÔ∏è</button>
        </div>

        <div class="row">
          <label class="chk">
            <input id="remember" type="checkbox" />
            <span>Recordarme</span>
          </label>

          <button id="submitBtn" class="primary" type="submit">Ingresar</button>
        </div>

        <p id="error" class="error" role="alert" hidden></p>
      </form>

      <p class="help">¬øProblemas para entrar? Contact√° al administrador para restablecer tu clave.</p>
    </section>
  </main>

  <script>
    const STORAGE_KEY = 'loginapp_credentials';

    // Cargar recordatorio si existe
    (function preloadRemembered(){
      try {
        const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
        if (saved.username) {
          document.getElementById('user').value = saved.username || '';
          if (saved.password) {
            document.getElementById('pass').value = saved.password || '';
            document.getElementById('remember').checked = true;
          }
        }
      } catch {}
    })();

    // Mostrar/ocultar password
    document.getElementById('togglePw').addEventListener('click', () => {
      const input = document.getElementById('pass');
      input.type = (input.type === 'password') ? 'text' : 'password';
    });

    // Enviar login
    const form = document.getElementById('loginForm');
    const btn  = document.getElementById('submitBtn');
    const err  = document.getElementById('error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      err.hidden = true;
      btn.disabled = true;
      btn.textContent = 'Ingresando‚Ä¶';

      const username = document.getElementById('user').value.trim();
      const password = document.getElementById('pass').value;

      if (!username || !password) {
        showError('Complet√° usuario y contrase√±a.'); resetBtn(); return;
      }

      try {
        const res = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await res.json();

        if (!data.ok) {
          showError(data.error || 'Usuario o contrase√±a inv√°lidos.');
          resetBtn(); return;
        }

        // Recordar credenciales (opcional y local)
        if (document.getElementById('remember').checked) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify({ username, password }));
        } else {
          localStorage.removeItem(STORAGE_KEY);
        }

        // Redirigir al panel (aj√∫stalo si quer√©s otra p√°gina)
        window.location.href = '/dashboard.html';
      } catch (e2) {
        showError('No se pudo conectar con el servidor.');
        resetBtn();
      }
    });

    function showError(msg) {
      err.textContent = msg;
      err.hidden = false;
    }
    function resetBtn() {
      btn.disabled = false;
      btn.textContent = 'Ingresar';
    }
  </script>
</body>
</html>
